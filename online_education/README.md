**Инструкция по запуску docker-compose.yml**

*Описание сервисов*

web:
- Создает контейнер веб-приложения, используя Dockerfile в текущем каталоге.
- Предоставляет доступ к HTTP-трафику через порт 8000.
- Подключает текущий каталог к контейнеру, чтобы включить горячую перезагрузку во время разработки.
- web сервис запускается после сервиса db.
- Загружает переменные среды из файла .env.

db:
- Использует официальный образ PostgreSQL версии 16.
- Данные сохраняются в именованном томе postgres_data, расположенном по адресу /var/lib/postgresql/data.
- Загружает переменные среды из файла .env для настройки.

celery:
- Создает Celery worker для обработки фоновых задач.
- Подключается к Redis, используя предоставленный REDIS_URL.
- Перезапускается при сбое в обеспечении доступности.
- Зависит от сервисов db и redis.

redis:
- Запускает официальный образ Redis версии 7.4.
- Открывает доступ к серверу Redis через порт 6379.
- Сохраняет данные Redis в локальном каталоге (например, ./redis/data).
- Загружает переменные среды из файла .env

celery-beat:
- Создает другой сервис Celery специально для планировщика beat.
- Выполняется независимо для планирования заданий с заданными интервалами.
- Зависит от сервисов db и redis.

Volumes:
- postgres_data: Сохраняет данные базы данных PostgreSQL.
- static_volume: Используется для обработки статических файлов из приложения, гарантируя, что они не будут потеряны между перезапусками контейнера.

Запуск:

Создайте env-файл:

Убедитесь, что в корневом каталоге создан env-файл с необходимыми переменными среды как для веб-сервисов, так и для сервисов базы данных.

- POSTGRES_DB=
- POSTGRES_USER=
- POSTGRES_PASSWORD=
- DATABASE_HOST=
- DATABASE_PORT=

- EMAIL_HOST=
- EMAIL_PORT=
- EMAIL_HOST_USER=
- EMAIL_HOST_PASSWORD=
- EMAIL_USE_TLS=True
- EMAIL_SENDER=
- EMAIL_USE_SSL=False

Создайте и запустите сервисы:

Выполните следующую команду для создания и запуска всех служб, как определено в файле docker-compose.yml:
docker-compose up --build


**Пояснение к файлу Dockerfile**

Предоставленный файл Dockerfile определяет среду для приложения Python:

- Базовый образ: приложение использует python:3.11.9 в качестве базового образа.
- Установка Poetry: он устанавливает Poetry, менеджер зависимостей для Python.
- Переменные среды: для установки зависимостей непосредственно в контейнер задается значение POETRY_VIRTUALENVS_CREATE=false.
- Рабочий каталог: в качестве рабочего каталога задается значение /code.
- Копирование файлов проекта: копируются pyproject.toml и poetry.lock файлы в контейнере и устанавливает зависимости, не включая корневой пакет.
- Заключительная копия: копирует остальной код приложения в контейнер.
- Команда: указывает команду для запуска сервера Django на порту 8000, что делает его доступным из-за пределов контейнера.


**Конвейер Django CI**

Этот репозиторий содержит конфигурацию непрерывной интеграции (CI) для приложения Django, использующего GitHub Actions. Конвейер CI включает в себя три основные задачи: тестирование, создание образа Docker и развертывание на сервере.

Конвейер CI запускается при двух событиях: push, pull_request.

Jobs

1. test

Переменные среды: SECRET_KEY извлекается из GitHub secrets для безопасного хранения.

- Checkout Code: код извлечен из репозитория.
- Set Up Python: Установлена версия Python 3.11.9.
- Install Poetry: Poetry устанавливается с помощью pip.
- Install Poetry: Необходимые зависимости устанавливаются без корневого пакета.
- Run Tests: Тесты Django выполняются с использованием Poetry.

2. build

Dependencies: это задание зависит от успешного завершения тестового задания.

- Checkout Code: Код будет возвращен еще раз.
- Log in to Docker Hub: пройдите аутентификацию в Docker Hub, используя секретные данные для имени пользователя и токена доступа.
- Build Docker Image: создайте образ Docker, помеченный SHA для фиксации загружаемого кода.
- Push Docker Image: Созданный образ Docker будет отправлен в Docker Hub.

3. deploy

Это задание запускается только после успешного завершения задания сборки.

Set up SSH: Используйте SSH для безопасного подключения к серверу развертывания с помощью закрытого ключа, хранящегося в GitHub secrets.
Deploy to Server: выполняются следующие команды:
- Извлеките последний образ Docker из Docker Hub.
- Останавливает любой запущенный в данный момент контейнер с именем online_education.
- Удалите остановленный контейнер.
- Запустите новый контейнер из последнего образа, сопоставив порт 8080 на хосте с портом 80 на контейнере. Используйте SSH для безопасного подключения к серверу развертывания с помощью закрытого ключа, хранящегося в GitHub secrets.
- Развертывание на сервере: выполняются следующие команды:
- Извлеките последний образ Docker из Docker Hub.
- Остановите любой запущенный в данный момент контейнер с именем online_education.
- Удалите остановленный контейнер.
- Запустите новый контейнер из последнего образа, сопоставив порт 8080 на хосте с портом 80 на контейнере.

Настройка секретов
Для обеспечения безопасной работы в репозитории GitHub должны быть настроены следующие секреты:

SECRET_KEY: секретный ключ Django.
DOCKER_HUB_USERNAME: Имя пользователя в Docker Hub.
DOCKER_HUB_ACCESS_TOKEN: Токен доступа Docker Hub для аутентификации.
SSH_KEY: Закрытый SSH-ключ для доступа к серверу развертывания.
SSH_USER: имя пользователя сервера по SSH.
SERVER_IP: IP-адрес сервера, на котором будет развернуто приложение.
